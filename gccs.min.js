#!/bin/env node
var http=require("http"),https=require("https"),fs=require("fs"),path=require("path"),querystring=require("querystring");
if(module.parent)compile.file=compileFile,compile.cli_usage=usage,module.exports=compile;else{var in_file=process.argv[2],out_file=process.argv[3];in_file||(process.stderr.write("Missing input filename"),usage(process.stderr),process.exit(1));out_file||(out_file=path.join(path.dirname(in_file),path.basename(in_file,".js")+".min.js"));compileFile(in_file,out_file,function(c){c&&(console.error(c),process.exit(2));"-"!=out_file&&console.log("\u001b[32m%s\u001b[0m",out_file)})}
function compile(c,a){var b=Object.assign({output_info:"compiled_code",output_format:"text",compilation_level:"SIMPLE_OPTIMIZATIONS",warning_level:"QUIET",js_code:c},"object"==typeof c?c:{}),d=443,e=https;!1===b.https&&(d=80,e=http);delete b.https;b=querystring.stringify(b);d=e.request({hostname:"closure-compiler.appspot.com",port:d,path:"/compile",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(b)}},function(b){var d=[];b.on("data",function(b){d.push(b)});
b.on("end",function(){a(null,d=Buffer.concat(d).toString("utf8"),b)})});d.on("error",a);d.write(b);d.end();return d}function compileFile(c,a,b){b||"function"!=typeof a||(b=a,a=void 0);if(a)if("string"==typeof a){var d=a;a=void 0}else a.out_file&&(d=a.out_file,delete a.out_file);return fs.readFile(c,"utf8",function(c,f){c?b(c):compile(Object.assign({},a,{js_code:f}),function(a,c){if(a)return b(a);d?"-"==d?(process.stdout.write(c),b(null,c)):fs.writeFile(d,c,"utf8",b):b(a,c)})})}
function usage(c){var a="Usage: "+path.basename(process.argv[1])+" <in_file> [<out_file> | -]\n    If <out_file> is ommited, out_file = in_file.min.js\n";if(c)c.write(a);else return a};
